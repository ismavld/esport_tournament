<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>API Tournois E-sport</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="container">
    <header>
      <div class="header-content">
        <div class="logo">
          <span class="logo-icon">üéÆ</span>
          <span>E-Sport Tournaments</span>
        </div>
        <nav>
          <a href="#" data-page="home" class="nav-link active">Accueil</a>
          <a href="#" data-page="tournaments" class="nav-link">Tournois</a>
          <a href="#" data-page="teams" class="nav-link">√âquipes</a>
          <a href="#" data-page="auth" class="nav-link">Connexion</a>
          <a href="http://localhost:5000/api-docs" target="_blank" class="nav-link">üìö Swagger</a>
        </nav>
      </div>
    </header>

    <!-- HOME PAGE -->
    <div id="home" class="page active">
      <div class="hero">
        <h1>üéÆ Bienvenue sur E-Sport Tournaments</h1>
        <p>Plateforme compl√®te de gestion de tournois e-sport</p>
        <div class="hero-buttons">
          <button class="btn btn-primary" onclick="showPage('tournaments')">
            Voir les Tournois
          </button>
          <button class="btn btn-secondary" onclick="showPage('auth')">
            Se Connecter
          </button>
        </div>
      </div>

      <div class="stats">
        <div class="stat-box">
          <div class="stat-number" id="stat-tournaments">0</div>
          <div class="stat-label">Tournois</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="stat-teams">0</div>
          <div class="stat-label">√âquipes</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="stat-players">0</div>
          <div class="stat-label">Joueurs</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="stat-registrations">0</div>
          <div class="stat-label">Inscriptions</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">‚ÑπÔ∏è √Ä Propos</div>
        <p>
          Cette API REST g√®re compl√®tement les tournois e-sport avec authentification,
          gestion d'√©quipes, et syst√®me d'inscriptions.
        </p>
        <ul style="margin-top: 16px; margin-left: 20px; line-height: 1.8">
          <li><strong>Authentification JWT</strong> - S√©curis√©e avec bcrypt</li>
          <li><strong>Gestion de Tournois</strong> - CRUD complet + gestion de statut</li>
          <li><strong>√âquipes</strong> - Cr√©ation et modification avec autorisation</li>
          <li><strong>Inscriptions</strong> - Syst√®me flexible SOLO/TEAM</li>
          <li><strong>Statistiques</strong> - M√©triques d√©taill√©es par tournoi</li>
          <li><strong>Tests</strong> - Suite Vitest avec 23 tests</li>
        </ul>
      </div>

      <div class="card">
        <div class="card-title">üîë Identifiants de Test</div>
        <table class="table">
          <thead>
            <tr>
              <th>Email</th>
              <th>R√¥le</th>
              <th>Mot de passe</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>alexis.dupont@example.com</td>
              <td><span class="badge badge-solo">PLAYER</span></td>
              <td>Password123</td>
            </tr>
            <tr>
              <td>admin.cs@example.com</td>
              <td><span class="badge badge-team">ORGANIZER</span></td>
              <td>Password123</td>
            </tr>
            <tr>
              <td>admin@esport.com</td>
              <td><span class="badge" style="background: #fce7f3; color: #be123c">ADMIN</span></td>
              <td>Password123</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- TOURNAMENTS PAGE -->
    <div id="tournaments" class="page">
      <div class="card">
        <div class="card-title">üèÜ Tournois</div>
        <div id="tournaments-list" class="grid"></div>
      </div>
    </div>

    <!-- TEAMS PAGE -->
    <div id="teams" class="page">
      <div class="card">
        <div class="card-title">üë• √âquipes</div>
        <div id="teams-list" class="grid"></div>
      </div>
    </div>

    <!-- AUTH PAGE -->
    <div id="auth" class="page">
      <div class="card" style="max-width: 500px; margin: 0 auto">
        <div class="card-title">üîê Connexion</div>
        <div id="auth-message"></div>
        <form id="login-form" onsubmit="handleLogin(event)">
          <div class="form-group">
            <label>Email:</label>
            <input type="email" name="email" required />
          </div>
          <div class="form-group">
            <label>Mot de passe:</label>
            <input type="password" name="password" required />
          </div>
          <button type="submit" class="btn btn-primary">Se Connecter</button>
        </form>

        <div id="token-section" style="display: none; margin-top: 24px">
          <div class="card">
            <div class="card-title">‚úÖ Vous √™tes connect√©</div>
            <div id="user-info"></div>
            <div style="margin-top: 16px">
              <button class="btn btn-danger" onclick="logout()">Se D√©connecter</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';

    // Navigation
    function showPage(pageName) {
      document.querySelectorAll('.page').forEach((p) => p.classList.remove('active'));
      document.getElementById(pageName).classList.add('active');

      document.querySelectorAll('.nav-link').forEach((link) => {
        link.classList.remove('active');
        if (link.dataset.page === pageName) link.classList.add('active');
      });

      if (pageName === 'tournaments') loadTournaments();
      if (pageName === 'teams') loadTeams();
      if (pageName === 'auth') checkAuth();
    }

    document.querySelectorAll('.nav-link').forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        showPage(link.dataset.page);
      });
    });

    // Load data on page load
    async function loadStats() {
      try {
        const [tournaments, teams, users] = await Promise.all([
          fetch(`${API_URL}/tournaments`).then((r) => r.json()),
          fetch(`${API_URL}/teams`).then((r) => r.json()),
          fetch(`${API_URL}/auth/users`, { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } })
            .then((r) => (r.ok ? r.json() : { data: [] }))
            .catch(() => ({ data: [] })),
        ]);

        document.getElementById('stat-tournaments').textContent =
          tournaments.data?.length || 0;
        document.getElementById('stat-teams').textContent = teams.data?.length || 0;
        document.getElementById('stat-players').textContent = users.data?.length || 0;
        document.getElementById('stat-registrations').textContent = '0';
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load tournaments
    async function loadTournaments() {
      const container = document.getElementById('tournaments-list');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

      try {
        const response = await fetch(`${API_URL}/tournaments`);
        const result = await response.json();
        const tournaments = result.data || [];

        if (tournaments.length === 0) {
          container.innerHTML = '<p>Aucun tournoi disponible</p>';
          return;
        }

        container.innerHTML = tournaments
          .map(
            (t) => `
          <div class="tournament-card">
            <div class="tournament-name">${t.name}</div>
            <div class="tournament-game">üéÆ ${t.game}</div>
            <div>
              <span class="badge badge-${t.status.toLowerCase()}">${t.status}</span>
              <span class="badge badge-${t.format.toLowerCase()}">${t.format}</span>
            </div>
            <div class="tournament-info">
              <strong>Max participants:</strong> ${t.maxParticipants}
            </div>
            <div class="tournament-info">
              <strong>Pool:</strong> $${(t.prizePool || 0).toLocaleString()}
            </div>
            <div class="tournament-info">
              <strong>D√©but:</strong> ${new Date(t.startDate).toLocaleDateString('fr-FR')}
            </div>
            <button class="btn btn-primary btn-small" onclick="viewStats('${t.id}')">
              üìä Statistiques
            </button>
          </div>
        `
          )
          .join('');
      } catch (error) {
        container.innerHTML = `<p>‚ùå Erreur: ${error.message}</p>`;
      }
    }

    // Load teams
    async function loadTeams() {
      const container = document.getElementById('teams-list');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

      try {
        const response = await fetch(`${API_URL}/teams`);
        const result = await response.json();
        const teams = result.data || [];

        if (teams.length === 0) {
          container.innerHTML = '<p>Aucune √©quipe disponible</p>';
          return;
        }

        container.innerHTML = teams
          .map(
            (t) => `
          <div class="tournament-card">
            <div class="tournament-name">üë• ${t.name}</div>
            <div class="tournament-game">Tag: <strong>${t.tag}</strong></div>
            <div class="tournament-info">
              <strong>Capitaine:</strong> ${t.captain?.username || 'N/A'}
            </div>
            <button class="btn btn-primary btn-small" onclick="alert('√âquipe: ' + '${t.name}')">
              D√©tails
            </button>
          </div>
        `
          )
          .join('');
      } catch (error) {
        container.innerHTML = `<p>‚ùå Erreur: ${error.message}</p>`;
      }
    }

    // Authentication
    function checkAuth() {
      const token = localStorage.getItem('token');
      const user = localStorage.getItem('user');

      if (token && user) {
        const userData = JSON.parse(user);
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('token-section').style.display = 'block';
        document.getElementById('user-info').innerHTML = `
          <p><strong>Utilisateur:</strong> ${userData.username}</p>
          <p><strong>Email:</strong> ${userData.email}</p>
          <p><strong>R√¥le:</strong> <span class="badge">${userData.role}</span></p>
          <p><strong>Token:</strong> <code style="font-size: 10px; word-break: break-all">${token.substring(0, 50)}...</code></p>
        `;
      } else {
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('token-section').style.display = 'none';
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      const email = e.target.email.value;
      const password = e.target.password.value;

      try {
        const response = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        const result = await response.json();

        if (result.data) {
          localStorage.setItem('token', result.data.token);
          localStorage.setItem('user', JSON.stringify(result.data.user));
          document.getElementById('auth-message').innerHTML =
            '<div class="alert alert-success">‚úÖ Connexion r√©ussie!</div>';
          setTimeout(() => checkAuth(), 500);
        } else {
          document.getElementById('auth-message').innerHTML =
            '<div class="alert alert-error">‚ùå ' + (result.error?.message || 'Erreur de connexion') + '</div>';
        }
      } catch (error) {
        document.getElementById('auth-message').innerHTML =
          '<div class="alert alert-error">‚ùå Erreur: ' + error.message + '</div>';
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      checkAuth();
      document.getElementById('auth-message').innerHTML =
        '<div class="alert alert-info">‚ÑπÔ∏è Vous avez √©t√© d√©connect√©</div>';
    }

    async function viewStats(tournamentId) {
      try {
        const response = await fetch(`${API_URL}/tournaments/${tournamentId}/stats`, {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
        });
        const result = await response.json();
        const stats = result.data;

        alert(`
üìä Statistiques - ${stats.tournament.name}

Total inscriptions: ${stats.registrations.total}
- PENDING: ${stats.registrations.statusBreakdown.PENDING}
- CONFIRMED: ${stats.registrations.statusBreakdown.CONFIRMED}
- REJECTED: ${stats.registrations.statusBreakdown.REJECTED}

Capacit√©: ${stats.capacity.confirmed}/${stats.capacity.max} (${stats.capacity.percentageFilled}%)
        `);
      } catch (error) {
        alert('‚ùå Erreur: Vous devez √™tre connect√©');
      }
    }

    // Initial load
    loadStats();
  </script>
</body>
</html>
