<%- include('../partials/header', { page: 'tournaments', title: 'Tournois - E-Sport Tournaments' }) %>

      <div class="page-header">
        <h1>üèÜ Tournois</h1>
        <p>D√©couvrez et g√©rez tous les tournois e-sport disponibles</p>
      </div>

      <!-- Toast Notification -->
      <div id="notification" style="display: none; position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 6px; font-weight: bold; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
      </div>

      <div class="card">
        <div class="card-title">üìã Liste des Tournois</div>
        <p>Les tournois seront charg√©s depuis l'API.</p>
        <div id="tournaments-list" style="margin-top: 20px;">
          <p style="color: #888;">Chargement des tournois...</p>
        </div>
      </div>

      <div class="card">
        <div class="card-title">‚ûï Cr√©er un Tournoi</div>
        <div id="tournament-create">
          <p style="margin-bottom: 20px;">Pour cr√©er un tournoi, vous devez √™tre connect√© en tant qu'organisateur.</p>
          <a href="/connexion" class="btn btn-primary">Se Connecter pour Cr√©er</a>
        </div>
        <div id="tournament-create-form" style="display: none;">
          <form id="create-tournament-form">
            <div class="form-group">
              <label for="tournament-name">Nom du Tournoi:</label>
              <input type="text" id="tournament-name" name="name" required />
            </div>
            <div class="form-group">
              <label for="tournament-game">Jeu:</label>
              <input type="text" id="tournament-game" name="game" placeholder="ex: Counter-Strike 2" required />
            </div>
            <div class="form-group">
              <label for="tournament-format">Format:</label>
              <select id="tournament-format" name="format" required>
                <option value="SOLO">Solo</option>
                <option value="TEAM">√âquipe</option>
              </select>
            </div>
            <div class="form-group">
              <label for="tournament-maxp">Participants Max:</label>
              <input type="number" id="tournament-maxp" name="maxParticipants" min="1" required />
            </div>
            <div class="form-group">
              <label for="tournament-pool">Prize Pool:</label>
              <input type="number" id="tournament-pool" name="prizePool" min="0" step="0.01" required />
            </div>
            <div class="form-group">
              <label for="tournament-start">Date de D√©but:</label>
              <input type="datetime-local" id="tournament-start" name="startDate" required />
            </div>
            <button type="submit" class="btn btn-primary">Cr√©er le Tournoi</button>
          </form>
        </div>
      </div>

      <script>
        function showNotification(message, isSuccess = true) {
          const notification = document.getElementById('notification');
          notification.textContent = message;
          notification.style.display = 'block';
          notification.style.backgroundColor = isSuccess ? '#10b981' : '#ef4444';
          notification.style.color = 'white';
          
          setTimeout(() => {
            notification.style.display = 'none';
          }, 3000);
        }

        async function createTournament(e) {
          e.preventDefault();
          
          const token = localStorage.getItem('token');
          if (!token) {
            showNotification('‚ùå Vous devez √™tre connect√© pour cr√©er un tournoi', false);
            return;
          }

          const formData = {
            name: document.getElementById('tournament-name').value,
            game: document.getElementById('tournament-game').value,
            format: document.getElementById('tournament-format').value,
            maxParticipants: parseInt(document.getElementById('tournament-maxp').value),
            prizePool: parseFloat(document.getElementById('tournament-pool').value),
            startDate: new Date(document.getElementById('tournament-start').value).toISOString()
          };

          try {
            const response = await fetch('/api/tournaments', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (response.ok) {
              showNotification('‚úÖ Tournoi cr√©√© avec succ√®s!', true);
              document.getElementById('create-tournament-form').reset();
              loadTournaments();
            } else {
              showNotification(`‚ùå Erreur: ${data.message || 'Impossible de cr√©er le tournoi'}`, false);
            }
          } catch (error) {
            console.error('Error:', error);
            showNotification('‚ùå Erreur r√©seau: ' + error.message, false);
          }
        }

        async function loadTournaments() {
          try {
            const response = await fetch('/api/tournaments/public/all');
            const tournaments = await response.json();
            
            const container = document.getElementById('tournaments-list');
            
            if (!Array.isArray(tournaments) || tournaments.length === 0) {
              container.innerHTML = '<p style="color: #888;">Aucun tournoi disponible pour le moment.</p>';
            } else {
              container.innerHTML = tournaments.map(t => `
                <div class="tournament-item" style="border: 1px solid #e5e7eb; padding: 12px; margin-bottom: 8px; border-radius: 6px;">
                  <strong>${t.name}</strong> - ${t.game} (${t.format})
                  <br><small style="color: #666;">Max: ${t.maxParticipants} | Prize Pool: $${t.prizePool}</small>
                </div>
              `).join('');
            }
          } catch (error) {
            console.error('Error:', error);
            document.getElementById('tournaments-list').innerHTML = '<p style="color: #f87171;">Erreur de connexion √† l\'API.</p>';
          }
        }

        function updateTournamentUI() {
          const token = localStorage.getItem('token');
          const user = localStorage.getItem('user');
          
          const createSection = document.getElementById('tournament-create');
          const createForm = document.getElementById('tournament-create-form');
          
          if (token && user) {
            try {
              const userObj = JSON.parse(user);
              if (userObj.role === 'ORGANIZER' || userObj.role === 'ADMIN') {
                createSection.style.display = 'none';
                createForm.style.display = 'block';
                return;
              }
            } catch (e) {
              console.error('Error parsing user:', e);
            }
          }
          
          // Default: show login message
          createSection.style.display = 'block';
          createForm.style.display = 'none';
        }

        // Attach form submit handler
        document.getElementById('create-tournament-form').addEventListener('submit', createTournament);

        loadTournaments();
        updateTournamentUI();
        window.addEventListener('storage', () => {
          loadTournaments();
          updateTournamentUI();
        });
      </script>

<%- include('../partials/footer') %>
